@model IEnumerable<LinkifyBLL.ModelView.PostMV>

@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;


}
@functions {
    string FormatSince(TimeSpan since)
    {
        if (since.TotalMinutes < 60)
            return $"{since.TotalMinutes:0} min ago";
        if (since.TotalHours < 24)
            return $"{since.TotalHours:0} hour{(since.TotalHours >= 2 ? "s" : "")} ago";
        if (since.TotalDays < 30)
            return $"{since.TotalDays:0} day{(since.TotalDays >= 2 ? "s" : "")} ago";
        return $"{(since.TotalDays / 30):0} month{(since.TotalDays / 30 >= 2 ? "s" : "")} ago";
    }
}
@functions {
    bool HasUserReacted(IEnumerable<CommentReactionMV> reactions, string userId, string reactionType)
    {
        return reactions != null && reactions.Any(r =>
            r.ReactorId == userId &&
            r.Reaction.ToString() == reactionType &&
            (r.IsDeleted == false || r.IsDeleted == null)
        );
    }
}

@functions {
    bool HasUserReactedToPost(IEnumerable<PostReactionMV> reactions, string userId, string reactionType)
    {
        return reactions != null && reactions.Any(r =>
            r.ReactorId == userId &&
            r.Reaction.ToString() == reactionType &&
            (r.IsDeleted == false || r.IsDeleted == null)
        );
    }
}


<h2>Posts</h2>

@foreach (var post in Model)
{
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center">
            <img src="@post.PostUserImg" alt="User Image" width="40" height="40" class="rounded-circle me-2" />
            <div>
                <strong>@post.PostUserName</strong> <br />
                <small>@post.PostUserTitle</small>
            </div>
            <span class="ms-auto text-muted">@FormatSince(post.Since)</span>
            @* Place this inside your post card, e.g., in the card-header or card-body *@
            <form asp-controller="Job" asp-action="SaveJob" method="post" style="display:inline;">
                <input type="hidden" name="postId" value="@post.postId" />
                <input type="hidden" name="userId" value="@currentUserId" />
                <button type="submit" class="btn btn-link p-0" title="Save Job">

                    
                </button>
            </form>

        </div>
        <div class="card-body">
            <p>@post.TextContent</p>
            @if (post.Images != null && post.Images.Any())
            {
                <div class="d-flex flex-wrap gap-2 mt-2 post-image-gallery">
                    @foreach (var img in post.Images)
                    {
                        <img src="@img"
                             alt="Post Image"
                             class="post-img-thumb"
                             loading="lazy" />
                    }
                </div>
            }

            <div class="mt-2">
                <span><strong>@post.LikeCount</strong> 👍</span>
                <span><strong>@post.LoveCount</strong> ❤️</span>
                <span><strong>@post.LaughCount</strong> 😂</span>
                <span><strong>@post.SadCount</strong> 😢</span>
                <span><strong>@post.AngryCount</strong> 😡</span>
                <span class="ms-3"><strong>@post.CommentsCount</strong> Comments</span>
                <span class="ms-3"><strong>@post.NumberOfShares</strong> Shares</span>
            </div>

            <div class="mt-2">
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Like" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-primary btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Like") ? "active" : "")">
                        👍 Like
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Love" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-danger btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Love") ? "active" : "")">
                        ❤️ Love
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Haha" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-warning btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Haha") ? "active" : "")">
                        😂 Haha
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Sad" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-info btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Sad") ? "active" : "")">
                        😢 Sad
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Angry" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-dark btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Angry") ? "active" : "")">
                        😡 Angry
                    </button>
                </form>
            </div>


        </div>
        @if (post.Comments != null && post.Comments.Any())
        {
            <div class="card-footer">
                <strong>Comments:</strong>
                <ul>
                    @foreach (var comment in post.Comments)
                    {
                        <li>
                            
                            @comment.TextContent
                            @if (!string.IsNullOrEmpty(comment.ImagePath))
                            {
                                <img src="@comment.ImagePath" alt="Comment Image" style="max-width:50px;max-height:50px;margin-left:5px;" />
                            }
                            @* Add Reply Comment *@
                            <a asp-controller="Comment" asp-action="Reply"
                               asp-route-parentCommentId="@comment.CommentID"
                               asp-route-postId="@comment.PostId"
                               asp-route-commenterId="@currentUserId"
                               class="btn btn-sm btn-secondary ms-2">
                                Reply
                            </a>
                            <div class="mt-2">
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />
                                    <input type="hidden" name="reactionType" value="Like" />
                                    <button type="submit"
                                            class="btn btn-outline-primary btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Like") ? "active" : "")">
                                        👍 Like
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />
                                    <input type="hidden" name="reactionType" value="Love" />
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm @(HasUserReacted(comment.Reactions,currentUserId, "Love") ? "active" : "")">
                                        ❤️ Love
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Haha" />
                                    <button type="submit"
                                            class="btn btn-outline-warning btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Haha") ? "active" : "")">
                                        😂 Haha
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Sad" />
                                    <button type="submit"
                                            class="btn btn-outline-info btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Sad") ? "active" : "") ">
                                        😢 Sad
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Angry" />
                                    <button type="submit"
                                            class="btn btn-outline-dark btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Angry") ? "active" : "")">
                                        😡 Angry
                                    </button>
                                </form>
                            </div>

                                <!-- Edit Button -->
                                <a asp-controller="Comment" asp-action="EditComment" action="GET"
                                   
                                   asp-route-CommentId="@comment.CommentID"
                                   asp-route-OldImgPath="@comment.ImagePath"
                                   asp-route-ParentCommentId="@comment.ParentCommentId"
                                   asp-route-PostId="@comment.PostId"
                                   asp-route-OldText="@comment.TextContent"
                                   asp-route-CommenterId="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value"
                                   
                                   class="btn btn-sm btn-warning ms-2">
                                    Edit
                                </a>
                                <!-- Delete Button -->
                            <form asp-controller="Comment" asp-action="DeleteComment" asp-route-CommentID="@comment.CommentID" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Are you sure you want to delete this comment?');">
                                        Delete
                                    </button>
                                </form>

                            @if (comment.Replies != null && comment.Replies.Any())
                            {
                                <ul class="ms-4">
                                    @foreach (var reply in comment.Replies)
                                    {
                                        <li>
                                            <span>@reply.TextContent</span>
                                            @if (!string.IsNullOrEmpty(reply.ImagePath))
                                            {
                                                <img src="@reply.ImagePath" alt="Reply Image" style="max-width:40px;max-height:40px;margin-left:5px;" />
                                            }
                                            <!-- Edit Reply Button -->
                                            <a asp-controller="Comment" asp-action="EditReply" action="GET"
                                               asp-route-ReplyId="@reply.CommentID"
                                               asp-route-OldImgPath="@reply.ImagePath"
                                               asp-route-ParentCommentId="@reply.ParentCommentId"
                                               asp-route-PostId="@reply.PostId"
                                               asp-route-OldText="@reply.TextContent"
                                               asp-route-CommenterId="@reply.CommenterId"
                                               class="btn btn-sm btn-warning ms-2">
                                                Edit
                                            </a>
                                            <!-- Delete Reply Button -->
                                            <form asp-controller="Comment" asp-action="DeleteReply" asp-route-ReplyId="@reply.CommentID" method="post" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Are you sure you want to delete this reply?');">
                                                    Delete
                                                </button>
                                            </form>
                                        </li>
                                    }
                                </ul>
                            }

                        
                        
                        </li>
                    
                    }
                </ul>
            </div>
        }
    </div>
}



<a asp-controller="Comment" asp-action="TestComment" class="btn btn-success">
    Write Comment
</a>

<a asp-controller="Post" asp-action="CreatePost" class="btn btn-success">
    Write Post
</a>

<style>
    .post-image-gallery {
        gap: 12px;
    }

    .post-img-thumb {
        max-width: 120px;
        max-height: 120px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
        object-fit: cover;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-bottom: 6px;
        background: #fafafa;
    }

        .post-img-thumb:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 16px rgba(0,0,0,0.16);
            z-index: 2;
        }
</style>
