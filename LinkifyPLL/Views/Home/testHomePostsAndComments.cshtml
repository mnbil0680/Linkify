@model IEnumerable<LinkifyBLL.ModelView.PostMV>

@{
    Layout = "~/Views/Shared/_AppLayout.cshtml";

    var currentUserId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;

}
@functions {
    string FormatSince(TimeSpan since)
    {
        if (since.TotalMinutes < 60)
            return $"{since.TotalMinutes:0} min ago";
        if (since.TotalHours < 24)
            return $"{since.TotalHours:0} hour{(since.TotalHours >= 2 ? "s" : "")} ago";
        if (since.TotalDays < 30)
            return $"{since.TotalDays:0} day{(since.TotalDays >= 2 ? "s" : "")} ago";
        return $"{(since.TotalDays / 30):0} month{(since.TotalDays / 30 >= 2 ? "s" : "")} ago";
    }
}
@functions {
    bool HasUserReacted(IEnumerable<CommentReactionMV> reactions, string userId, string reactionType)
    {
        return reactions != null && reactions.Any(r =>
            r.ReactorId == userId &&
            r.Reaction.ToString() == reactionType &&
            (r.IsDeleted == false || r.IsDeleted == null)
        );
    }
}

@functions {
    bool HasUserReactedToPost(IEnumerable<PostReactionMV> reactions, string userId, string reactionType)
    {
        return reactions != null && reactions.Any(r =>
            r.ReactorId == userId &&
            r.Reaction.ToString() == reactionType &&
            (r.IsDeleted == false || r.IsDeleted == null)
        );
    }
}


<h2>Posts</h2>

@foreach (var post in Model)
{
    <div class="card mb-3">
        <div class="card-header d-flex align-items-center">
            <img src="@post.PostUserImg" alt="User Image" width="40" height="40" class="rounded-circle me-2" />
            <div>
                <strong>@post.PostUserName</strong> <br />
                <small>@post.PostUserTitle</small>
            </div>
            <span class="ms-auto text-muted">@FormatSince(post.Since)</span>
        </div>
        <div class="card-body">
            <p>@post.TextContent</p>
            @if (post.Images != null && post.Images.Any())
            {
                <div>
                    @foreach (var img in post.Images)
                    {
                        <img src="@img" alt="Post Image" style="max-width:100px;max-height:100px;margin-right:5px;" />
                    }
                </div>
            }
            <div class="mt-2">
                <span><strong>@post.LikeCount</strong> 👍</span>
                <span><strong>@post.LoveCount</strong> ❤️</span>
                <span><strong>@post.LaughCount</strong> 😂</span>
                <span><strong>@post.SadCount</strong> 😢</span>
                <span><strong>@post.AngryCount</strong> 😡</span>
                <span class="ms-3"><strong>@post.CommentsCount</strong> Comments</span>
                <span class="ms-3"><strong>@post.NumberOfShares</strong> Shares</span>
            </div>

            <div class="mt-2">
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Like" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-primary btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Like") ? "active" : "")">
                        👍 Like
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Love" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-danger btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Love") ? "active" : "")">
                        ❤️ Love
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Haha" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-warning btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Haha") ? "active" : "")">
                        😂 Haha
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Sad" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-info btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Sad") ? "active" : "")">
                        😢 Sad
                    </button>
                </form>
                <form asp-controller="Post" asp-action="ToggleReaction" method="post" style="display:inline;">
                    <input type="hidden" name="postId" value="@post.postId" />
                    <input type="hidden" name="reactionType" value="Angry" />
                    <input type="hidden" name="userId" value="@currentUserId" />
                    <button type="submit"
                            class="btn btn-outline-dark btn-sm @(HasUserReactedToPost(post.Reactions, currentUserId, "Angry") ? "active" : "")">
                        😡 Angry
                    </button>
                </form>
            </div>


        </div>
        @if (post.Comments != null && post.Comments.Any())
        {
            <div class="card-footer">
                <strong>Comments:</strong>
                <ul>
                    @foreach (var comment in post.Comments)
                    {
                        <li>
                            
                            @comment.TextContent
                            @if (!string.IsNullOrEmpty(comment.ImagePath))
                            {
                                <img src="@comment.ImagePath" alt="Comment Image" style="max-width:50px;max-height:50px;margin-left:5px;" />
                            }
                            <div class="mt-2">
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />
                                    <input type="hidden" name="reactionType" value="Like" />
                                    <button type="submit"
                                            class="btn btn-outline-primary btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Like") ? "active" : "")">
                                        👍 Like
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value" />
                                    <input type="hidden" name="reactionType" value="Love" />
                                    <button type="submit"
                                            class="btn btn-outline-danger btn-sm @(HasUserReacted(comment.Reactions,currentUserId, "Love") ? "active" : "")">
                                        ❤️ Love
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Haha" />
                                    <button type="submit"
                                            class="btn btn-outline-warning btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Haha") ? "active" : "")">
                                        😂 Haha
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Sad" />
                                    <button type="submit"
                                            class="btn btn-outline-info btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Sad") ? "active" : "") ">
                                        😢 Sad
                                    </button>
                                </form>
                                <form asp-controller="Comment" asp-action="ToggleReaction" method="post" style="display:inline;">
                                    <input type="hidden" name="commentId" value="@comment.CommentID" />
                                    <input type="hidden" name="userId" value="@currentUserId" />
                                    <input type="hidden" name="reactionType" value="Angry" />
                                    <button type="submit"
                                            class="btn btn-outline-dark btn-sm @(HasUserReacted(comment.Reactions, currentUserId, "Angry") ? "active" : "")">
                                        😡 Angry
                                    </button>
                                </form>
                            </div>

                                <!-- Edit Button -->
                                <a asp-controller="Comment" asp-action="EditComment" action="GET"
                                   
                                   asp-route-CommentId="@comment.CommentID"
                                   asp-route-OldImgPath="@comment.ImagePath"
                                   asp-route-ParentCommentId="@comment.ParentCommentId"
                                   asp-route-PostId="@comment.PostId"
                                   asp-route-OldText="@comment.TextContent"
                                   asp-route-CommenterId="@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value"
                                   
                                   class="btn btn-sm btn-warning ms-2">
                                    Edit
                                </a>
                                <!-- Delete Button -->
                            <form asp-controller="Comment" asp-action="DeleteComment" asp-route-CommentID="@comment.CommentID" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger ms-1" onclick="return confirm('Are you sure you want to delete this comment?');">
                                        Delete
                                    </button>
                                </form>

                            
                        </li>
                    }
                </ul>
            </div>
        }
    </div>
}



<a asp-controller="Comment" asp-action="TestComment" class="btn btn-success">
    Write Comment
</a>

