@model List<PoepleMV>
@{
    ViewData["Title"] = "My Connections";
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
}

<link rel="stylesheet" href="~/css/connections.css" />

<div class="container">
    <div class="connections-header">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-2">My Network</h1>
                <div class="connections-count">
                    <strong>@Model.Count()</strong> Connection@(Model.Count() != 1 ? "s" : "")
                </div>
            </div>
            <div>
                <button class="btn btn-outline-primary rounded-pill">
                    <i class="fas fa-user-plus me-2"></i>Grow Your Network
                </button>
            </div>
        </div>
        
        <div class="search-sort-container">
            <div class="search-box flex-grow-1">
                <i class="fas fa-search"></i>
                <input type="text" 
                       id="searchInput" 
                       class="form-control search-input" 
                       placeholder="Search your connections..."
                       autocomplete="off">
            </div>
            
            <select class="form-select sort-dropdown" id="sortSelect">
                <option value="firstName">Sort by first name</option>
                <option value="lastName">Sort by last name</option>
                <option value="recent">Sort by recently added</option>
            </select>
        </div>
    </div>

    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4" id="connectionsContainer">
        @foreach (var connection in Model)
        {
            <div class="col connection-item" 
                 data-name="@connection.Name.ToLower()"
                 data-date="@connection.Id"> 
                <div class="connection-card">
                    <div class="position-relative">
                        @if (!string.IsNullOrEmpty(connection.ImgPath))
                        {
                            <img src="@connection.ImgPath" 
                                 alt="@connection.Name" 
                                 class="connection-image">
                        }
                        else
                        {
                            <div class="connection-placeholder">
                                <i class="fas fa-user"></i>
                            </div>
                        }
                    </div>
                    
                    <h3 class="connection-name">
                        <a href="@Url.Action("Profile", "Home", new { id = connection.Id })" 
                           class="text-decoration-none text-dark">
                            @connection.Name
                        </a>
                    </h3>
                    
                    @if (!string.IsNullOrEmpty(connection.Title))
                    {
                        <p class="connection-title">@connection.Title</p>
                    }
                    
                    @if (connection.MutualFriendsCount > 0)
                    {
                        <div class="mutual-friends">
                            <i class="fas fa-user-friends"></i>
                            @connection.MutualFriendsCount mutual connection@(connection.MutualFriendsCount == 1 ? "" : "s")
                        </div>
                    }
                    
                    <div class="connection-actions">
                        <button class="btn btn-message" 
                                onclick="location.href='#'" 
                                title="Send message">
                            <i class="fas fa-comment-dots me-2"></i>Message
                        </button>
                        
                        <div class="dropdown">
                            <button class="btn btn-light" 
                                    data-bs-toggle="dropdown" 
                                    aria-expanded="false"
                                    title="More actions">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" 
                                       href="@Url.Action("Profile", "Home", new { id = connection.Id })">
                                        <i class="fas fa-user"></i>View Full Profile
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="fas fa-share"></i>Share Profile
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#">
                                        <i class="fas fa-bell"></i>Follow Posts
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-danger remove-connection" 
                                       href="#" 
                                       data-user-id="@connection.Id">
                                        <i class="fas fa-user-minus"></i>Remove Connection
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <div class="mb-3">
                <i class="fas fa-user-friends fa-3x text-muted"></i>
            </div>
            <h3>No connections yet</h3>
            <p class="text-muted">Start growing your network by connecting with people you know.</p>
            <a href="@Url.Action("PeopleYouMayKnow", "Home")" class="btn btn-primary rounded-pill">
                Find Connections
            </a>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            // Search functionality with debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                const input = $(this);
                searchTimeout = setTimeout(function() {
                    const searchTerm = input.val().toLowerCase();
                    $('.connection-item').each(function() {
                        const name = $(this).data('name');
                        $(this).toggle(name.includes(searchTerm));
                    });
                    updateConnectionCount();
                }, 300);
            });

            // Sort functionality
            $('#sortSelect').on('change', function() {
                const sortBy = $(this).val();
                const $container = $('#connectionsContainer');
                const $items = $('.connection-item').get();

                $items.sort(function(a, b) {
                    if (sortBy === 'firstName' || sortBy === 'lastName') {
                        const nameA = $(a).data('name');
                        const nameB = $(b).data('name');
                        return nameA.localeCompare(nameB);
                    } else if (sortBy === 'recent') {
                        const dateA = $(a).data('date');
                        const dateB = $(b).data('date');
                        return dateB.localeCompare(dateA);
                    }
                });

                $container.append($items);
            });

            // Remove connection functionality with SweetAlert2
            $('.remove-connection').on('click', function(e) {
                e.preventDefault();
                const userId = $(this).data('user-id');
                const $card = $(this).closest('.connection-item');
                const name = $card.find('.connection-name').text().trim();
                
                Swal.fire({
                    title: 'Remove Connection?',
                    html: `Are you sure you want to remove <strong>${name}</strong> from your connections?`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Remove',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: '/Friends/Unfriend',
                            type: 'POST',
                            data: { id: userId },
                            success: function() {
                                $card.fadeOut(300, function() {
                                    $(this).remove();
                                    updateConnectionCount();
                                    Swal.fire(
                                        'Removed',
                                        `${name} has been removed from your connections.`,
                                        'success'
                                    );
                                });
                            },
                            error: function() {
                                Swal.fire(
                                    'Error',
                                    'Failed to remove connection. Please try again.',
                                    'error'
                                );
                            }
                        });
                    }
                });
            });

            function updateConnectionCount() {
                const count = $('.connection-item:visible').length;
                $('.connections-count').html(
                    `<strong>${count}</strong> Connection${count !== 1 ? 's' : ''}`
                );
            }
        });
    </script>
}